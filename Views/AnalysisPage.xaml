<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="SkinMonitor.Views.AnalysisPage"
             xmlns:controls="clr-namespace:SkinMonitor.Views"
             xmlns:models="clr-namespace:SkinMonitor.Models"
             xmlns:viewmodels="clr-namespace:SkinMonitor.ViewModels"
             x:DataType="viewmodels:AnalysisPageViewModel"
             Title="AI Analysis"
             BackgroundColor="White">

    <Grid RowDefinitions="*,Auto">
        <!-- Main Content -->
        <ScrollView Grid.Row="0">
            <VerticalStackLayout Padding="20" Spacing="20">

                <!-- Title -->
                <Label Text="AI Wound Analysis"
                       FontSize="28"
                       FontAttributes="Bold"
                       TextColor="#212121"
                       HorizontalOptions="Center" />

                <!-- Status Message -->
                <Label Text="{Binding StatusMessage}"
                       FontSize="16"
                       TextColor="#757575"
                       HorizontalOptions="Center"
                       HorizontalTextAlignment="Center" />

                <!-- Wound Selection -->
                <Border BackgroundColor="#F8F9FA" Padding="20" Margin="0,10">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="15" />
                    </Border.StrokeShape>

                    <VerticalStackLayout Spacing="15">
                        <Label Text="Select Wound to Analyze"
                               FontSize="18"
                               FontAttributes="Bold"
                               TextColor="#212121" />

                        <CollectionView ItemsSource="{Binding WoundsWithPhotos}"
                                      SelectionMode="Single"
                                      SelectedItem="{Binding SelectedWound}"
                                      SelectionChangedCommand="{Binding SelectWoundCommand}"
                                      SelectionChangedCommandParameter="{Binding SelectedWound}"
                                      HeightRequest="200">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:Wound">
                                    <Grid Padding="10" BackgroundColor="White" Margin="0,5">
                                            <RoundRectangle CornerRadius="10" />
                                        
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="60" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <!-- Thumbnail -->
                                        <Border Grid.Column="0" BackgroundColor="#512BD4" 
                                                WidthRequest="50" HeightRequest="50">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="25" />
                                            </Border.StrokeShape>
                                            <Label Text="ðŸ“·" FontSize="20" 
                                                   HorizontalOptions="Center" VerticalOptions="Center" />
                                        </Border>

                                        <!-- Wound Info -->
                                        <VerticalStackLayout Grid.Column="1" Margin="10,0" VerticalOptions="Center">
                                            <Label Text="{Binding Name}" FontSize="16" FontAttributes="Bold" />
                                            <Label Text="{Binding BodyLocation}" FontSize="14" TextColor="#757575" />
                                            <Label Text="{Binding Photos.Count, StringFormat='{0} photos'}" 
                                                   FontSize="12" TextColor="#757575" />
                                        </VerticalStackLayout>

                                        <!-- Selection Indicator -->
                                        <Label Grid.Column="2" Text="â–¶" FontSize="20" TextColor="#512BD4" 
                                               VerticalOptions="Center" />
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Border>

                <!-- Analysis Button -->
                <Button Text="{Binding IsAnalyzing, Converter={StaticResource BoolToTextConverter}}"
                        Command="{Binding AnalyzeWoundCommand}"
                        BackgroundColor="#4CAF50"
                        TextColor="White"
                        CornerRadius="15"
                        Padding="20,15"
                        FontSize="16"
                        FontAttributes="Bold"
                        IsEnabled="{Binding IsAnalyzing, Converter={StaticResource InverseBoolConverter}}" />

                <!-- Analysis Results -->
                <Border BackgroundColor="White" Padding="20" Margin="0,10"
                        IsVisible="{Binding HasAnalysisResult}">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="15" />
                    </Border.StrokeShape>
                    <Border.Shadow>
                        <Shadow Brush="Black" Opacity="0.15" Radius="8" Offset="0,2" />
                    </Border.Shadow>

                    <VerticalStackLayout Spacing="15">
                        <Label Text="Analysis Results"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="#212121" />

                        <!-- Wound Classification -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Wound Type Classification"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#212121" />
                            <Label Text="{Binding AnalysisResult.Classification.PrimaryType}"
                                   FontSize="18"
                                   TextColor="#512BD4"
                                   FontAttributes="Bold" />
                            <Label Text="{Binding AnalysisResult.Classification.Confidence, StringFormat='Confidence: {0:P1}'}"
                                   FontSize="14"
                                   TextColor="#757575" />
                        </VerticalStackLayout>

                        <!-- Wound Area -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Wound Area"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#212121" />
                            <Label Text="{Binding AnalysisResult.WoundAreaCm2, StringFormat='{0:F2} cmÂ²'}"
                                   FontSize="18"
                                   TextColor="#FF9800"
                                   FontAttributes="Bold" />
                        </VerticalStackLayout>

                        <!-- Infection Risk -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Infection Risk"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#212121" />
                            <Label Text="{Binding AnalysisResult.InfectionRisk.RiskLevel}"
                                   FontSize="18"
                                   TextColor="{Binding AnalysisResult.InfectionRisk.RiskLevel, Converter={StaticResource RiskLevelColorConverter}}"
                                   FontAttributes="Bold" />
                            <Label Text="{Binding AnalysisResult.InfectionRisk.RiskScore, StringFormat='Score: {0:P1}'}"
                                   FontSize="14"
                                   TextColor="#757575" />
                        </VerticalStackLayout>

                        <!-- Recommendations -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Recommendations"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#212121" />
                            <CollectionView ItemsSource="{Binding AnalysisResult.InfectionRisk.Recommendations}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <HorizontalStackLayout Spacing="8" Padding="0,2">
                                            <Label Text="â€¢" TextColor="#512BD4" FontSize="14" />
                                            <Label Text="{Binding}" FontSize="14" TextColor="#212121" />
                                        </HorizontalStackLayout>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>

                    </VerticalStackLayout>
                </Border>

                <!-- Loading Indicator -->
                <ActivityIndicator IsVisible="{Binding IsAnalyzing}"
                                 IsRunning="{Binding IsAnalyzing}"
                                 Color="#512BD4"
                                 HeightRequest="50" />

            </VerticalStackLayout>
        </ScrollView>

        <!-- Bottom Navigation -->
        <controls:NavigationBar Grid.Row="1" BindingContext="{Binding NavigationViewModel}" />
    </Grid>
</ContentPage>
